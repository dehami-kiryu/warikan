<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒ¼ãƒˆå‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .result-positive {
            color: #16a34a;
            font-weight: 600;
        }
        .result-negative {
            color: #dc2626;
            font-weight: 600;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">ã‚¹ãƒãƒ¼ãƒˆå‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</h1>
            <p class="text-gray-600 mt-2">æ—…è¡Œã‚„ã‚¤ãƒ™ãƒ³ãƒˆã§ã®é¢å€’ãªè¨ˆç®—ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦å´: å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div>
                <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-users mr-2 text-blue-500"></i>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>
                    <div class="flex gap-2">
                        <input type="text" id="memberName" class="input-field" placeholder="ãƒ¡ãƒ³ãƒãƒ¼å (ä¾‹: å±±ç”°)">
                        <button onclick="addMember()" class="btn btn-primary flex-shrink-0">è¿½åŠ </button>
                    </div>
                    <ul id="memberList" class="mt-4 space-y-2">
                        <!-- ãƒ¡ãƒ³ãƒãƒ¼ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </ul>
                </div>

                <!-- æ”¯æ‰•ã„ç™»éŒ² -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-wallet mr-2 text-green-500"></i>æ”¯æ‰•ã„ç™»éŒ²</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="paidBy" class="block text-sm font-medium text-gray-600 mb-1">æ”¯æ‰•ã£ãŸäºº</label>
                            <select id="paidBy" class="input-field"></select>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-600 mb-1">é‡‘é¡ (å††)</label>
                            <input type="number" id="amount" class="input-field" placeholder="5000">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-600 mb-1">å†…å®¹</label>
                            <input type="text" id="description" class="input-field" placeholder="å¤•é£Ÿä»£">
                        </div>
                        <button onclick="addPayment()" class="btn btn-primary w-full">æ”¯æ‰•ã„ã‚’è¨˜éŒ²</button>
                    </div>
                </div>
            </div>

            <!-- å³å´: çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div>
                <!-- ã‚µãƒãƒªãƒ¼ -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-calculator mr-2 text-purple-500"></i>ã‚µãƒãƒªãƒ¼</h2>
                    <div class="space-y-3 text-gray-600">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">åˆè¨ˆé‡‘é¡:</span>
                            <span id="totalAmount" class="font-bold text-2xl text-gray-800">0 å††</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium">ãƒ¡ãƒ³ãƒãƒ¼æ•°:</span>
                            <span id="memberCount" class="font-bold text-lg text-gray-800">0 äºº</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">1äººã‚ãŸã‚Šã®é‡‘é¡:</span>
                            <span id="perPersonAmount" class="font-bold text-lg text-blue-600">0 å††</span>
                        </div>
                    </div>
                </div>

                <!-- å„ãƒ¡ãƒ³ãƒãƒ¼ã®æ”¯æ‰•ã„çŠ¶æ³ -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-chart-pie mr-2 text-yellow-500"></i>æ”¯æ‰•ã„çŠ¶æ³</h2>
                    <div id="paymentStatus" class="space-y-3">
                        <!-- æ”¯æ‰•ã„çŠ¶æ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- æ¸…ç®—æ–¹æ³• -->
                <div class="card">
                     <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-exchange-alt mr-2 text-red-500"></i>æ¸…ç®—æ–¹æ³•</h2>
                     <div id="settlement" class="space-y-2">
                        <!-- æ¸…ç®—æ–¹æ³•ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        <p class="text-gray-500 text-center">ãƒ¡ãƒ³ãƒãƒ¼ã¨æ”¯æ‰•ã„ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                     </div>
                </div>
            </div>
        </div>
        
        <!-- æ”¯æ‰•ã„å±¥æ­´ -->
        <div class="card mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-history mr-2 text-indigo-500"></i>æ”¯æ‰•ã„å±¥æ­´</h2>
            <div id="paymentHistory" class="space-y-2">
                 <p class="text-gray-500 text-center">ã¾ã æ”¯æ‰•ã„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </div>

    </div>

    <script>
        let members = [];
        let payments = [];
        let nextMemberId = 1;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateUI();
        });

        function addMember() {
            const memberNameInput = document.getElementById('memberName');
            const name = memberNameInput.value.trim();

            if (name && !members.some(m => m.name === name)) {
                members.push({ id: nextMemberId++, name: name });
                memberNameInput.value = '';
                updateUI();
            } else if (!name) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            } else {
                alert('åŒã˜åå‰ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
            }
        }
        
        function removeMember(id) {
            if (confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹æ”¯æ‰•ã„ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                members = members.filter(m => m.id !== id);
                payments = payments.filter(p => p.memberId !== id);
                updateUI();
            }
        }

        function addPayment() {
            const paidBySelect = document.getElementById('paidBy');
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');

            const memberId = parseInt(paidBySelect.value);
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();

            if (memberId && amount > 0 && description) {
                payments.push({ memberId, amount, description });
                amountInput.value = '';
                descriptionInput.value = '';
                updateUI();
            } else {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        function removePayment(index) {
            if(confirm('ã“ã®æ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                payments.splice(index, 1);
                updateUI();
            }
        }

        function updateUI() {
            renderMembers();
            const summary = calculateSummary();
            renderSummary(summary);
            renderPaymentStatus(summary.balances);
            renderSettlement(summary.balances);
            renderPaymentHistory();
            saveToLocalStorage();
        }

        function renderMembers() {
            const memberList = document.getElementById('memberList');
            const paidBySelect = document.getElementById('paidBy');

            memberList.innerHTML = '';
            paidBySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

            if (members.length === 0) {
                 memberList.innerHTML = '<p class="text-gray-500 text-sm">ã¾ã ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚</p>';
            }

            members.forEach(member => {
                // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤º
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                li.innerHTML = `
                    <span class="text-gray-700">${member.name}</span>
                    <button onclick="removeMember(${member.id})" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button>
                `;
                memberList.appendChild(li);

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                paidBySelect.appendChild(option);
            });
        }
        
        function calculateSummary() {
            const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
            const memberCount = members.length;
            const perPersonAmount = memberCount > 0 ? totalAmount / memberCount : 0;

            const balances = members.map(member => {
                const paid = payments
                    .filter(p => p.memberId === member.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                return {
                    ...member,
                    paid: paid,
                    balance: paid - perPersonAmount,
                };
            });
            
            return { totalAmount, memberCount, perPersonAmount, balances };
        }

        function renderSummary(summary) {
            document.getElementById('totalAmount').textContent = `${Math.round(summary.totalAmount).toLocaleString()} å††`;
            document.getElementById('memberCount').textContent = `${summary.memberCount} äºº`;
            document.getElementById('perPersonAmount').textContent = `${Math.round(summary.perPersonAmount).toLocaleString()} å††`;
        }

        function renderPaymentStatus(balances) {
            const paymentStatusDiv = document.getElementById('paymentStatus');
            paymentStatusDiv.innerHTML = '';
            
            if (balances.length === 0) {
                paymentStatusDiv.innerHTML = '<p class="text-gray-500 text-center">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            balances.forEach(b => {
                const balanceClass = b.balance >= 0 ? 'result-positive' : 'result-negative';
                const sign = b.balance >= 0 ? '+' : '';
                const div = document.createElement('div');
                div.className = 'flex justify-between items-baseline';
                div.innerHTML = `
                    <span class="font-medium text-gray-700">${b.name}</span>
                    <div class="text-right">
                        <span class="${balanceClass}">${sign}${Math.round(b.balance).toLocaleString()} å††</span>
                        <p class="text-xs text-gray-500">æ”¯æ‰•é¡: ${b.paid.toLocaleString()} å††</p>
                    </div>
                `;
                paymentStatusDiv.appendChild(div);
            });
        }
        
        function renderSettlement(balances) {
            const settlementDiv = document.getElementById('settlement');
            settlementDiv.innerHTML = '';
            
            if (members.length < 2) {
                 settlementDiv.innerHTML = '<p class="text-gray-500 text-center">ãƒ¡ãƒ³ãƒãƒ¼ãŒ2äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚</p>';
                 return;
            }

            const debtors = balances.filter(b => b.balance < 0).map(b => ({ ...b, balance: -b.balance }));
            const creditors = balances.filter(b => b.balance > 0);
            
            if (debtors.length === 0 || creditors.length === 0) {
                settlementDiv.innerHTML = '<p class="text-green-600 text-center font-semibold">ğŸ‰ å…¨å“¡ç²¾ç®—æ¸ˆã¿ã§ã™ï¼</p>';
                return;
            }

            const transactions = [];
            debtors.sort((a, b) => a.balance - b.balance);
            creditors.sort((a, b) => a.balance - b.balance);

            let debtorIndex = 0;
            let creditorIndex = 0;

            while (debtorIndex < debtors.length && creditorIndex < creditors.length) {
                const debtor = debtors[debtorIndex];
                const creditor = creditors[creditorIndex];
                const amount = Math.min(debtor.balance, creditor.balance);
                
                if (amount > 0.1) { // å°æ•°ç‚¹èª¤å·®ã‚’è€ƒæ…®
                     transactions.push({ from: debtor.name, to: creditor.name, amount });
                }

                debtor.balance -= amount;
                creditor.balance -= amount;

                if (debtor.balance < 0.1) debtorIndex++;
                if (creditor.balance < 0.1) creditorIndex++;
            }
            
            transactions.forEach(t => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-blue-50 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-red-600">${t.from}</span>
                    <i class="fas fa-long-arrow-alt-right text-gray-500"></i>
                    <span class="font-medium text-green-600">${t.to}</span>
                    <span class="font-bold text-blue-800">${Math.round(t.amount).toLocaleString()} å††</span>
                `;
                settlementDiv.appendChild(div);
            });
        }
        
        function renderPaymentHistory() {
            const historyDiv = document.getElementById('paymentHistory');
            historyDiv.innerHTML = '';

            if (payments.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center">ã¾ã æ”¯æ‰•ã„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            
            // æ–°ã—ã„æ”¯æ‰•ã„ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é€†é †ã§è¡¨ç¤º
            [...payments].reverse().forEach((p, index) => {
                const member = members.find(m => m.id === p.memberId);
                if (member) {
                     const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border-b';
                    const originalIndex = payments.length - 1 - index;
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${p.description}</p>
                            <p class="text-sm text-gray-500">æ”¯æ‰•ã£ãŸäºº: ${member.name}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-gray-800">${p.amount.toLocaleString()} å††</p>
                             <button onclick="removePayment(${originalIndex})" class="text-red-500 hover:text-red-700 text-xs mt-1"><i class="fas fa-times-circle"></i> å‰Šé™¤</button>
                        </div>
                    `;
                    historyDiv.appendChild(div);
                }
            });
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
        function saveToLocalStorage() {
            const data = { members, payments, nextMemberId };
            localStorage.setItem('warikanAppData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('warikanAppData');
            if (data) {
                const parsedData = JSON.parse(data);
                members = parsedData.members || [];
                payments = parsedData.payments || [];
                nextMemberId = parsedData.nextMemberId || 1;
            }
        }

    </script>
</body>
</html>
